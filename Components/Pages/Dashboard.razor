@page "/dashboard"
@rendermode InteractiveServer
@using System.Globalization
@using Microsoft.JSInterop

<h3>Customer Login Statistics Dashboard</h3>

<div class="mt-3 mb-3 d-flex gap-3">
    <div>
        <label>Date Range: from</label>
        <input type="date" class="form-control d-inline-block w-auto me-2"
        @bind="fromDate"
        @bind:after="async () => await DrawChart()" />
        <label>to</label>
        <input type="date" class="form-control d-inline-block w-auto"
        @bind="toDate"
        @bind:after="async () => await DrawChart()" />
    </div>
    <div>
        <label>Display mode: </label>
        <select class="form-select w-auto d-inline-block"
                value="@mode"
                @onchange="OnModeChange">
            <option value="year">By Year</option>
            <option value="month">By Month</option>
        </select>
    </div>
    <div>
        <label>Chart Type:</label>
        <select class="form-select w-auto d-inline-block"
                @bind="chartType"
                @bind:after="async () => await DrawChart()">
            <option value="bar">Bar Chart</option>
            <option value="line">Line Chart</option>
        </select>
    </div>
    <div>
        <button class="btn btn-secondary" @onclick="ExportChart">
            Export as PNG
        </button>
    </div>
</div>

<canvas id="loginChart" width="800" height="400"></canvas>

@code {
    private string mode = "year";
    private string chartType = "bar";
    private DateOnly? fromDate = null;
    private DateOnly? toDate = null;
    private Dictionary<string, List<(DateOnly Date, int Count, string Level)>>? data;

    [Inject] BlazorWebApp.Services.XmlStatisticsService StatsService { get; set; } = default!;
    [Inject] IJSRuntime JS { get; set; } = default!;

    protected override void OnInitialized()
    {
        data = StatsService.LoadStatistics();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await DrawChart();
        }
    }

    private async Task OnModeChange(ChangeEventArgs e)
    {
        mode = e.Value!.ToString()!;
        await DrawChart();
    }

    private async Task ExportChart()
    {
        await JS.InvokeVoidAsync("dashboardChart.exportChart", "loginChart");
    }

    private async Task DrawChart()
    {
        if (data == null) return;
        var filtered = FilterDataByDateRange();
        var labels = GetLabels(filtered);
        var datasets = GetDatasets(filtered, labels);

        await JS.InvokeVoidAsync(
            "dashboardChart.renderChart",
            "loginChart",
            labels,
            datasets,
            chartType
        );
    }

    private Dictionary<string, List<(DateOnly Date, int Count, string Level)>> FilterDataByDateRange()
    {
        var result = new Dictionary<string, List<(DateOnly, int, string)>>();

        foreach (var client in data!)
        {
            var filteredRows = client.Value.Where(r =>
                (!fromDate.HasValue || r.Date >= fromDate.Value) &&
                (!toDate.HasValue || r.Date <= toDate.Value)
            ).ToList();

            result[client.Key] = filteredRows;
        }

        return result;
    }

    // ------------------
    // Generate X-axis by year/month
    // ------------------
    private List<string> GetLabels(Dictionary<string, List<(DateOnly Date, int Count, string Level)>> filtered)
    {
        var all = filtered.SelectMany(x => x.Value).ToList();
        if (mode == "year")
        {
            return all.Where(x => x.Level == "YearStatistics")
                .Select(x => x.Date.Year.ToString())
                .Distinct()
                .OrderBy(x => x)
                .ToList();
        }
        else // month
        {
            return all.Where(x => x.Level == "MonthStatistics")
                .Select(x => $"{x.Date.Year}-{x.Date.Month:00}")
                .Distinct()
                .OrderBy(x => x)
                .ToList();
        }
    }

    // ------------------
    // Generate chart data
    // ------------------
    private List<object> GetDatasets(Dictionary<string, List<(DateOnly Date, int Count, string Level)>> filtered, List<string> labels)
    {
        return filtered.Select(client =>
            new
            {
                label = client.Key,
                data = labels.Select(label =>
                {
                    var matches = client.Value.Where(v =>
                        mode == "year" ? v.Level == "YearStatistics" && v.Date.Year.ToString() == label : v.Level == "MonthStatistics" && $"{v.Date.Year}-{v.Date.Month:00}" == label
                    );

                    return matches.Sum(x => x.Count);
                }).ToList()
            }
        ).Cast<object>().ToList();
    }
}
